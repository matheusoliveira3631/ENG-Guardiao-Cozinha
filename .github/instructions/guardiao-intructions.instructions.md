{
  "version": 1,
  "inference": {
    "instructions": [
      "You are generating code for a small academic web system called 'Guardião da Cozinha' (Kitchen Guardian). The goal of this system is to manage the stock of a kitchen: products, stock entries and exits, and simple reports. The context is a Software Engineering course: the code must be clean, simple, and aligned with an MVC architecture and a class diagram.",
      "Do NOT use any database or ORM. Persistence MUST be implemented using JSON files stored in a local 'data' folder. Do NOT install or use Prisma, Sequelize, Mongoose, MySQL, PostgreSQL, MongoDB, or any other database/ORM library.",
      "The project MUST be a Node.js + Express application using the MVC pattern with server-side rendered views using EJS templates. Do NOT use React, Vue, Angular, Next.js, or any SPA framework. All HTML that the user sees must come from EJS views rendered by Express.",
      "Use CommonJS syntax (require/module.exports) instead of ES modules, to keep things simple and compatible with most Node.js setups.",
      "The folder structure MUST follow this exact layout:",
      "guardiao-cozinha/",
      "  src/",
      "    app.js               # Express app configuration (views, static, routes, middlewares)",
      "    server.js            # Starts the HTTP server and imports app.js",
      "    controllers/         # Controllers: HTTP entry points, no business logic, no file IO",
      "      authController.js",
      "      produtoController.js",
      "      movimentacaoController.js",
      "      relatorioController.js",
      "    models/              # Domain classes mapped from the class diagram",
      "      Usuario.js",
      "      Administrador.js",
      "      Operador.js",
      "      Gestor.js",
      "      Produto.js",
      "      Movimentacao.js",
      "      TipoMovimentacao.js   # Enum-like object for movement type: ENTRADA, SAIDA",
      "    repositories/        # Data access: read/write JSON files only, no business rules",
      "      usuarioRepository.js",
      "      produtoRepository.js",
      "      movimentacaoRepository.js",
      "    services/            # Business logic: use repositories, enforce rules and validations",
      "      authService.js",
      "      produtoService.js",
      "      movimentacaoService.js",
      "      relatorioService.js",
      "    routes/              # Express Routers: map URLs to controller methods",
      "      authRoutes.js",
      "      produtoRoutes.js",
      "      movimentacaoRoutes.js",
      "      relatorioRoutes.js",
      "    views/               # EJS templates: the 'View' in MVC",
      "      layout.ejs         # Base layout with header/footer and <%- body %> placeholder",
      "      auth/",
      "        login.ejs",
      "      produtos/",
      "        list.ejs",
      "        create.ejs",
      "        edit.ejs",
      "      movimentacoes/",
      "        list.ejs",
      "        entrada.ejs",
      "        saida.ejs",
      "      relatorios/",
      "        estoque.ejs",
      "        movimentacoesUsuario.ejs",
      "    utils/               # Helper functions",
      "      fileUtils.js       # JSON read/write helpers, reused by all repositories",
      "      dateUtils.js       # Date parsing/formatting helpers",
      "    middlewares/         # Express middlewares",
      "      authMiddleware.js  # Ensures user is authenticated",
      "      errorMiddleware.js # Global error handler",
      "  data/",
      "    usuarios.json",
      "    produtos.json",
      "    movimentacoes.json",
      "  public/",
      "    css/",
      "      styles.css",
      "    js/",
      "      main.js",
      "    img/",
      "  package.json",
      "  README.md",
      "The core architectural rule: Controllers must NEVER access JSON files directly and MUST NOT contain business logic. Controllers only:",
      "  - read request data (params, query, body, session)",
      "  - call the appropriate service methods",
      "  - decide which view to render or where to redirect",
      "  - pass data to views.",
      "All business rules and validations MUST be implemented in the service layer. The service layer calls the repository layer to read/write data.",
      "The repository layer is the ONLY layer allowed to interact with the filesystem and JSON files. It MUST use utility functions from utils/fileUtils.js for reading and writing JSON data.",
      "Implement the following domain classes under src/models:",
      "Usuario.js:",
      "  - class Usuario represents a generic system user.",
      "  - Properties: id (string or number), nome (string), email (string), senha (string hashed or plain for now), perfil (string: 'ADMINISTRADOR', 'OPERADOR', 'GESTOR').",
      "  - The constructor must receive and assign these properties.",
      "  - Optionally expose a method validarSenha(senhaPlana) that compares a plain password with the stored one (initial version can be a simple comparison).",
      "Administrador.js:",
      "  - class Administrador extends Usuario.",
      "  - Represents an administrative user with permissions to manage products and users.",
      "  - It can reuse all properties from Usuario. The perfil should be 'ADMINISTRADOR'.",
      "Operador.js:",
      "  - class Operador extends Usuario.",
      "  - Represents a user responsible for registering stock entries and exits.",
      "  - perfil should be 'OPERADOR'.",
      "Gestor.js:",
      "  - class Gestor extends Usuario.",
      "  - Represents a user responsible for viewing reports and analyzing stock usage.",
      "  - perfil should be 'GESTOR'.",
      "Produto.js:",
      "  - class Produto.",
      "  - Properties: id (string or number), nome (string), categoria (string), quantidade (number), dataValidade (string in ISO or 'YYYY-MM-DD').",
      "  - The constructor must receive these values and assign them.",
      "Movimentacao.js:",
      "  - class Movimentacao.",
      "  - Represents a stock movement (entry or exit).",
      "  - Properties: id (string or number), produtoId (id of the product), usuarioId (id of the user that performed the movement), tipo (one of TipoMovimentacao.ENTRADA or TipoMovimentacao.SAIDA), quantidade (number), data (string date).",
      "  - The constructor must receive these values and assign them.",
      "TipoMovimentacao.js:",
      "  - Export a plain object used as an enum:",
      "    module.exports = { ENTRADA: 'ENTRADA', SAIDA: 'SAIDA' }.",
      "Implement the repository layer using JSON files in the /data folder. Repositories must be responsible for reading/writing arrays of plain JS objects, not class instances. They should convert data if needed at a higher layer (service).",
      "In utils/fileUtils.js implement helper functions such as:",
      "  - readJson(filePath): reads a JSON file from the given path and returns an array (or an empty array if the file does not exist or is empty).",
      "  - writeJson(filePath, data): writes the provided data (usually an array of objects) into the JSON file, overwriting its contents.",
      "These helpers should use Node's fs module (fs.readFileSync, fs.writeFileSync) or async equivalents, but MUST be reused by all repositories.",
      "Repository design:",
      "usuarioRepository.js:",
      "  - Uses data/usuarios.json.",
      "  - Expose functions: getAllUsuarios(), getUsuarioById(id), getUsuarioByEmail(email), createUsuario(usuarioData), updateUsuario(id, newData), deleteUsuario(id).",
      "produtoRepository.js:",
      "  - Uses data/produtos.json.",
      "  - Expose functions: getAllProdutos(), getProdutoById(id), createProduto(produtoData), updateProduto(id, newData), deleteProduto(id).",
      "movimentacaoRepository.js:",
      "  - Uses data/movimentacoes.json.",
      "  - Expose functions: getAllMovimentacoes(), getMovimentacoesByUsuario(usuarioId), getMovimentacoesByProduto(produtoId), createMovimentacao(movimentacaoData).",
      "Service layer rules: all business logic MUST be implemented here. Services consume repositories and enforce requirements from the requirements document, such as:",
      "  - A movement of type SAIDA cannot be created if there is not enough stock.",
      "  - When an ENTRADA is registered, the product stock must be increased.",
      "  - When a SAIDA is registered, the product stock must be decreased.",
      "  - Reports must aggregate data correctly.",
      "Implement the following services:",
      "authService.js:",
      "  - login(email, senha): use usuarioRepository.getUsuarioByEmail(email), validate the password, and return the user or null/throw error if invalid.",
      "produtoService.js:",
      "  - listarProdutos(): returns all products (using produtoRepository.getAllProdutos).",
      "  - obterProduto(id): returns a single product by id.",
      "  - criarProduto(dadosProduto): validates required fields (nome, categoria, quantidade, dataValidade), creates a new product with a generated id, and calls produtoRepository.createProduto.",
      "  - atualizarProduto(id, dadosProduto): validates and updates a product using produtoRepository.updateProduto.",
      "  - excluirProduto(id): deletes a product via produtoRepository.deleteProduto, but may block deletion if there are movimentacoes referencing this product (this check can be added later using movimentacaoRepository).",
      "movimentacaoService.js:",
      "  - registrarEntrada(produtoId, usuarioId, quantidade, data): validates that the product exists, creates a Movimentacao of type ENTRADA, updates the product stock accordingly, and persists the new movimentacao.",
      "  - registrarSaida(produtoId, usuarioId, quantidade, data): validates that the product exists and that there is enough stock, creates a Movimentacao of type SAIDA, updates the product stock, and persists.",
      "  - listarMovimentacoes(filtroOpcional): returns all movements, optionally filtered by user, product, or date range.",
      "relatorioService.js:",
      "  - gerarRelatorioEstoque(): returns a list of products with their current quantities.",
      "  - gerarRelatorioProdutosEmBaixa(quantidadeMinima): returns products whose quantity is below the given threshold.",
      "  - gerarRelatorioProdutosProximosDoVencimento(diasLimite): returns products near expiration based on current date.",
      "  - gerarRelatorioMovimentacoesPorUsuario(usuarioId, periodoOpcional): uses movimentacaoRepository to aggregate movements executed by a given user.",
      "Controllers (src/controllers) MUST be thin. They should:",
      "  - Receive Express req and res.",
      "  - Call the appropriate service method.",
      "  - Handle success (rendering a view or redirecting) and handle errors (using errorMiddleware or basic try/catch).",
      "Examples of controller responsibilities:",
      "produtoController.js:",
      "  - list(req, res): calls produtoService.listarProdutos() and renders 'produtos/list.ejs' with { produtos }. ",
      "  - showCreateForm(req, res): renders 'produtos/create.ejs'.",
      "  - create(req, res): reads form data from req.body, calls produtoService.criarProduto(dadosProduto), then redirects to the product list.",
      "  - showEditForm(req, res): loads a product by id and renders 'produtos/edit.ejs'.",
      "  - update(req, res): updates a product and redirects.",
      "  - remove(req, res): deletes a product and redirects.",
      "movimentacaoController.js must have similar methods for creating entrada and saída and listing movimentações.",
      "authController.js:",
      "  - showLoginForm(req, res): renders 'auth/login.ejs'.",
      "  - login(req, res): uses authService.login(email, senha). On success, stores user data in req.session and redirects to a main page (e.g. /produtos). On failure, re-renders login with an error message.",
      "relatorioController.js:",
      "  - estoque(req, res): uses relatorioService.gerarRelatorioEstoque() and renders 'relatorios/estoque.ejs'.",
      "  - movimentacoesPorUsuario(req, res): uses relatorioService.gerarRelatorioMovimentacoesPorUsuario and renders 'relatorios/movimentacoesUsuario.ejs'.",
      "In src/routes define Express Routers, mapping URLs to controller functions. Example for produtoRoutes.js:",
      "  - GET /produtos -> produtoController.list",
      "  - GET /produtos/novo -> produtoController.showCreateForm",
      "  - POST /produtos -> produtoController.create",
      "  - GET /produtos/:id/editar -> produtoController.showEditForm",
      "  - POST /produtos/:id -> produtoController.update",
      "  - POST /produtos/:id/excluir -> produtoController.remove",
      "In app.js:",
      "  - Configure Express, set view engine to EJS, set views folder to src/views, configure static folder as 'public', use body-parsing middlewares, and register route modules (authRoutes, produtoRoutes, movimentacaoRoutes, relatorioRoutes).",
      "  - Example: app.use('/produtos', produtoRoutes).",
      "In server.js, import app from src/app.js (using require), set the port (e.g. 3000), and call app.listen(port).",
      "EJS views:",
      "  - layout.ejs should define a basic HTML structure with a header, navigation, and a placeholder like <%- body %> where child views are injected.",
      "  - List views (e.g. produtos/list.ejs) should receive arrays from controllers and render HTML tables.",
      "  - Form views (create/edit) should use classic HTML forms posting to the appropriate routes.",
      "Global constraints:",
      "  - DO NOT introduce any new technology outside this stack: Node.js, Express, EJS, JSON persistence with fs.",
      "  - DO NOT introduce React, Vue, Angular, TypeScript, ORMs or any database.",
      "  - Keep controllers small and focused.",
      "  - Keep services cohesive: one responsibility per service file.",
      "  - Keep repository functions reusable and free of business rules.",
      "  - Prefer simple, readable code over clever solutions; this is an academic Software Engineering project."
    ]
  }
}
