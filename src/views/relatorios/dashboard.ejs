<%- include('../layout', { pageTitle: 'Relatórios', activeMenu: 'relatorios' }) %>
<div class="mb-6">
  <h1 class="text-2xl font-semibold">Relatórios</h1>
  <p class="text-gray-600">Visão consolidada do estoque e movimentações.</p>
</div>

<div class="grid grid-cols-1 md:grid-cols-2 gap-6">
  <div class="bg-white p-4 rounded-lg shadow">
    <h2 class="font-medium mb-3">Top 5 Produtos mais Adicionados</h2>
    <canvas id="chartTopEntradas" height="140"></canvas>
  </div>
  <div class="bg-white p-4 rounded-lg shadow">
    <h2 class="font-medium mb-3">Top 5 Produtos mais Retirados</h2>
    <canvas id="chartTopSaidas" height="140"></canvas>
  </div>
  <div class="bg-white p-4 rounded-lg shadow">
    <h2 class="font-medium mb-3">Top 5 Categorias com Mais Vencidos</h2>
    <canvas id="chartCategoriasVencidos" height="160"></canvas>
  </div>
  <div class="bg-white p-4 rounded-lg shadow">
    <h2 class="font-medium mb-3">Usuários com Mais Movimentações</h2>
    <canvas id="chartUsuariosMov" height="140"></canvas>
  </div>
</div>

<!-- Chart.js CDN -->
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
<script>
  const topEntradas = <%- JSON.stringify(topEntradas || []) %>;
  const topSaidas = <%- JSON.stringify(topSaidas || []) %>;
  const categoriasVencidos = <%- JSON.stringify(categoriasVencidos || []) %>;
  const usuariosMov = <%- JSON.stringify(usuariosMov || []) %>;

  const makeBar = (ctxId, data, color) => {
    const labels = data.map(i => i.label);
    const values = data.map(i => i.value);
    const ctx = document.getElementById(ctxId);
    if (!ctx) return;
    return new Chart(ctx, {
      type: 'bar',
      data: {
        labels,
        datasets: [{
          label: 'Quantidade',
          data: values,
          backgroundColor: color,
          borderRadius: 6
        }]
      },
      options: {
        plugins: { legend: { display: false } },
        scales: { y: { beginAtZero: true, ticks: { precision: 0 } } }
      }
    });
  };

  const makePie = (ctxId, data) => {
    const labels = data.map(i => i.label);
    const values = data.map(i => i.value);
    const colors = ['#60a5fa','#f87171','#34d399','#fbbf24','#a78bfa'];
    const ctx = document.getElementById(ctxId);
    if (!ctx) return;
    return new Chart(ctx, {
      type: 'pie',
      data: {
        labels,
        datasets: [{ data: values, backgroundColor: colors }]
      },
      options: { plugins: { legend: { position: 'bottom' } } }
    });
  };

  makeBar('chartTopEntradas', topEntradas, '#10b981');
  makeBar('chartTopSaidas', topSaidas, '#ef4444');
  makePie('chartCategoriasVencidos', categoriasVencidos);
  makeBar('chartUsuariosMov', usuariosMov, '#3b82f6');
</script>
<%- include('../partials/end') %>